##################################
## OpenOnDemand Server Template ##
##################################

[cluster OpenOnDemand]
FormLayout = selectionpanel
Category = Applications

    [[node defaults]]

    Credentials = $Credentials
    ImageName = $ImageName
    SubnetId = $SubnetId
    Region = $Region
    KeyPairLocation = ~/.ssh/cyclecloud.pem
    UsePublicNetwork = $UsePublicNetwork
    Azure.Identities = $ManagedIdentity

        [[[configuration]]]
        # May be used to identify the ID in cluster-init scripts
        cluster.identities.default = $ManagedIdentity

        # Open OnDemand options
        ood.auth_method = $ood_auth_method
        ## LDAP config - add values here if using LDAP
        ood.ldap_host= $ood_ldap_host  # LDAP server host and port
        ood.ldap_bind_dn=""  # Bind DN for LDAP
        ood.ldap_bind_pwd=""  # Password for the bind DN
        ood.ldap_user_base_dn=""  # Base DN for user entries
        ood.ldap_group_base_dn=""  # Base DN for group entries

        # Entra config - add values here if using Entra
        ood.entra_client_id=""  # Client ID for Entra
        ood.entra_client_secret=""  # Client Secret for Entra
        ood.entra_tenant_id=""  # Tenant ID for Entra



    [[node OOD]]

    MachineType = $MachineType
    IsReturnProxy = $ReturnProxy
    AdditionalClusterInitSpecs = $ClusterInitSpecs

        [[[configuration]]]
        cyclecloud.discoverable = true

        [[[volume boot]]]
        Size = ${ifThenElse(BootDiskSize > 0, BootDiskSize, undefined)}
        SSD = True

        [[[network-interface eth0]]]
        AssociatePublicIpAddress = $UsePublicNetwork

        [[[cluster-init ood:default:1.0.0]]]


[parameters About]
Order = 1

    [[parameters About OOD]]

        [[[parameter Filer]]]
        HideLabel = true
        Config.Plugin = pico.widget.HtmlTemplateWidget
        Config.Template = '''<table role="presentation"><tr><td><img alt="OOD logo" src="https://global.discourse-cdn.com/flex015/uploads/osc/original/2X/7/78efe89a41a9cc51322e7b38c4d1efc24a44e6ee.png" width="164" height="43"></td></tr><tr><td><p>Creates an <a href="https://openondemand.org/" target="_blank">Open OnDemand</a> portal that can be connected to CycleCloud Clusters</p><p>Follow the instructions in the <a href="https://github.com/xpillons/ood4cc/" target="_blank">README</a>for details on instructions on extending and configuring the Project for your environment.</p></td></tr></table>'''

        [[[parameter Readme]]]
        HideLabel = true
        Config.Plugin = pico.widget.HtmlTemplateWidget
        Config.Template := "Follow the instructions in the README for details on extending and configuring the project for your environment."


[parameters Required Settings]
Order = 10

    [[parameters Virtual Machines ]]
    Description = "settings for Open OnDemand virtual machine"
    Order = 20

        [[[parameter Region]]]
        Label = Region
        Description = Deployment Location
        ParameterType = Cloud.Region

        [[[parameter MachineType]]]
        Label = OOD Machine Type
        Description = The machine type for the Open OnDemand Server host
        ParameterType = Cloud.MachineType
        DefaultValue = Standard_D4as_v4

    [[parameters Networking]]
    Order = 40

        [[[parameter SubnetId]]]
        Label = Subnet ID
        Description = Subnet Resource Path (ResourceGroup/VirtualNetwork/Subnet)
        ParameterType = Azure.Subnet
        Required = True

[parameters Advanced Settings]
Order = 20

    [[parameters Open OnDemand Settings]]
    Order = 5

        [[[parameter ood_auth_method]]]
        Required = True
        Label = Authentication
        Description = Authentication Method
        ParameterType = StringList
        Config.Plugin = pico.form.Dropdown
        Config.FreeForm = true
        Config.Entries := {[Value="Basic"], [Value="LDAP"], [Value="Entra"]}
        DefaultValue = "Basic"

        [[[parameter ood_ldap_host]]]
        Label = LDAP Server 
        Description = The LDAP server host and port
        Config.ParameterType = String
        Conditions.Excluded := ood_auth_method isnt LDAP

    [[parameters Azure Settings]]
    Order = 10 

        [[[parameter Credentials]]]
        Description = The credentials for the cloud provider
        ParameterType = Cloud.Credentials

        [[[parameter ManagedIdentity]]]
        Label = Managed Id
        Description = Optionally assign an Azure user assigned managed identity to all nodes to access Azure resources using assigned roles.
        ParameterType = Azure.ManagedIdentity
        DefaultValue = =undefined

        [[[parameter BootDiskSize]]]
        Description = Optional: Size of the OS/boot disk in GB for all nodes in the cluster (leave at 0 to use Image size)
        ParameterType = Integer
        Config.Plugin = pico.form.NumberTextBox
        Config.MinValue = 0
        Config.MaxValue = 32,000
        Config.IntegerOnly = true
        Config.Increment = 64
        DefaultValue = 32


    [[parameters Software]]
    Description = "Specify the base OS installed - Alma Linux 8 = almalinux:almalinux-x86_64:8-gen2:latest Ubnutu22.04lts = canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest "

    Order = 10
        
        [[[parameter ImageName]]]
        Label = Image
        Description = Base OS for Open OnDemand
        ParameterType = StringList
        Config.Plugin = pico.form.Dropdown
        Config.FreeForm = true
        DefaultValue = "canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest"
        Config.Entries := {[Label="AlmaLinux 8"; Value="almalinux:almalinux-x86_64:8-gen2:latest"], [Label="Ubuntu 22.04 LTS"; Value="canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest"]}

        [[[parameter ClusterInitSpecs]]]
        Label = Cluster-Init Projects
        DefaultValue = =undefined
        Description = Cluster init specs to apply to the OOD VM
        ParameterType = Cloud.ClusterInitSpecs

    [[parameters Advanced Networking]]
    Description = Advanced networking settings

        [[[parameter ReturnProxy]]]
        Label = Return Proxy
        DefaultValue = false
        ParameterType = Boolean
        Config.Label = Use SSH tunnel to connect to CycleCloud (required if direct access is blocked)

        [[[parameter UsePublicNetwork]]]
        Label = Public IP
        DefaultValue = false
        ParameterType = Boolean
        Config.Label = Access master node from the Internet